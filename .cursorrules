# Cursor Rules cho Folkgroup Backend (Go)

## üåê Ng√¥n Ng·ªØ v√† Giao Ti·∫øp
- Lu√¥n l√†m vi·ªác b·∫±ng Ti·∫øng Vi·ªát
- Lu√¥n m√¥ t·∫£ v√† ch√∫ th√≠ch ƒë·∫ßy ƒë·ªß b·∫±ng Ti·∫øng Vi·ªát
- Comments trong code ph·∫£i b·∫±ng Ti·∫øng Vi·ªát
- Error messages v√† log messages ph·∫£i b·∫±ng Ti·∫øng Vi·ªát

## üìÅ C·∫•u Tr√∫c File v√† Naming Conventions

### File Naming
- Handler: `handler.<module>.<entity>.go` (v√≠ d·ª•: `handler.notification.trigger.go`)
- Service: `service.<module>.<entity>.go` (v√≠ d·ª•: `service.customer.go`)
- Model: `model.<module>.<entity>.go` (v√≠ d·ª•: `model.mongodb.user.go`)
- DTO: `dto.<module>.<entity>.go` (v√≠ d·ª•: `dto.customer.create.go`)
- Middleware: `middleware.<name>.go`
- Router: `router.<module>.go`

### Function Naming
- Handler methods: `Handle<Action><Entity>` (v√≠ d·ª•: `HandleCreateCustomer`, `HandleTriggerNotification`)
- Service methods: `<Action><Entity>` (v√≠ d·ª•: `CreateCustomer`, `FindOneById`)
- Private functions: `camelCase` (v√≠ d·ª•: `findSenderForChannel`)
- Public functions: `PascalCase` (v√≠ d·ª•: `NewCustomerHandler`)

### Variable Naming
- Constants: `UPPER_SNAKE_CASE` (v√≠ d·ª•: `STATUS_PENDING`)
- Variables: `camelCase` (v√≠ d·ª•: `customerID`, `baseURL`)
- Exported variables: `PascalCase` (v√≠ d·ª•: `DefaultConfig`)

## üèóÔ∏è Ki·∫øn Tr√∫c v√† Patterns

### Layered Architecture
```
Request ‚Üí Router ‚Üí Middleware ‚Üí Handler ‚Üí Service ‚Üí Repository ‚Üí Database
```

### Handler Pattern
- Handlers ph·∫£i k·∫ø th·ª´a t·ª´ `BaseHandler[T, CreateInput, UpdateInput]` khi c√≥ th·ªÉ
- S·ª≠ d·ª•ng `SafeHandlerWrapper` ƒë·ªÉ x·ª≠ l√Ω errors
- Lu√¥n tr·∫£ v·ªÅ `error` t·ª´ handler function
- Response format: `c.Status(code).JSON(fiber.Map{...})`

### Service Pattern
- Services ph·∫£i k·∫ø th·ª´a t·ª´ `BaseServiceMongoImpl[T]` khi c√≥ th·ªÉ
- T·∫•t c·∫£ service methods ph·∫£i nh·∫≠n `context.Context` l√†m tham s·ªë ƒë·∫ßu ti√™n
- Service methods tr·∫£ v·ªÅ `(result, error)`
- S·ª≠ d·ª•ng `common.ConvertMongoError()` ƒë·ªÉ convert MongoDB errors

### Error Handling
- Lu√¥n x·ª≠ l√Ω errors, kh√¥ng b·ªè qua
- S·ª≠ d·ª•ng `common.ErrorCode` v√† `common.NewError()` ƒë·ªÉ t·∫°o errors
- Convert MongoDB errors b·∫±ng `common.ConvertMongoError()`
- Tr·∫£ v·ªÅ `common.ErrNotFound` khi kh√¥ng t√¨m th·∫•y document
- Error messages ph·∫£i b·∫±ng Ti·∫øng Vi·ªát v√† r√µ r√†ng

### Context Usage
- Lu√¥n truy·ªÅn `context.Context` cho t·∫•t c·∫£ database operations
- S·ª≠ d·ª•ng `c.Context()` t·ª´ Fiber ƒë·ªÉ l·∫•y context
- Kh√¥ng t·∫°o context m·ªõi tr·ª´ khi c·∫ßn timeout ho·∫∑c cancellation

## üìù Code Structure

### Handler Structure
```go
func (h *Handler) HandleAction(c fiber.Ctx) error {
    return SafeHandlerWrapper(c, func() error {
        // 1. Parse input
        var input dto.Input
        if err := c.Bind().Body(&input); err != nil {
            c.Status(common.StatusBadRequest).JSON(fiber.Map{
                "code":    common.ErrCodeValidationFormat.Code,
                "message": "D·ªØ li·ªáu g·ª≠i l√™n kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng JSON",
                "status":  "error",
            })
            return nil
        }
        
        // 2. Validate
        if input.Field == "" {
            c.Status(common.StatusBadRequest).JSON(fiber.Map{
                "code":    common.ErrCodeValidationFormat.Code,
                "message": "Field kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng",
                "status":  "error",
            })
            return nil
        }
        
        // 3. Call service
        result, err := h.service.Action(c.Context(), &input)
        if err != nil {
            // Handle error appropriately
            return nil
        }
        
        // 4. Return response
        c.Status(common.StatusOK).JSON(fiber.Map{
            "code":    common.StatusOK,
            "message": "Thao t√°c th√†nh c√¥ng",
            "data":    result,
            "status":  "success",
        })
        return nil
    })
}
```

### Service Structure
```go
func (s *Service) Action(ctx context.Context, input *dto.Input) (*models.Entity, error) {
    // 1. Validate
    if err := validate(input); err != nil {
        return nil, err
    }
    
    // 2. Business logic
    entity := &models.Entity{
        // ...
    }
    
    // 3. Database operation
    result, err := s.InsertOne(ctx, entity)
    if err != nil {
        return nil, err
    }
    
    return result, nil
}
```

## üîí Security v√† Authorization

### Organization-based Data Authorization
- S·ª≠ d·ª•ng `OwnerOrganizationID` cho ph√¢n quy·ªÅn d·ªØ li·ªáu (data authorization)
- S·ª≠ d·ª•ng `OrganizationID` cho logic nghi·ªáp v·ª• (business logic)
- Lu√¥n ki·ªÉm tra v√† set `OwnerOrganizationID` t·ª´ context khi t·∫°o/update
- S·ª≠ d·ª•ng `getActiveOrganizationID()` ƒë·ªÉ l·∫•y organization ID t·ª´ context
- S·ª≠ d·ª•ng `setOrganizationID()` ƒë·ªÉ t·ª± ƒë·ªông g√°n organization ID

### System Data Protection
- Kh√¥ng cho ph√©p t·∫°o/update d·ªØ li·ªáu v·ªõi `IsSystem = true` t·ª´ API th√¥ng th∆∞·ªùng
- Ch·ªâ h·ªá th·ªëng (init process) m·ªõi c√≥ th·ªÉ t·∫°o system data
- Validate system data updates trong service layer

## üìä Logging

### Logging Patterns
- S·ª≠ d·ª•ng `logger.GetAppLogger()` ƒë·ªÉ l·∫•y logger instance
- S·ª≠ d·ª•ng structured logging v·ªõi fields:
  ```go
  log.WithFields(map[string]interface{}{
      "eventType": req.EventType,
      "channelId": channel.ID.Hex(),
  }).Info("üîî [NOTIFICATION] Message")
  ```
- Log levels:
  - `Info`: Th√¥ng tin quan tr·ªçng, flow b√¨nh th∆∞·ªùng
  - `Warn`: C·∫£nh b√°o, c√≥ th·ªÉ b·ªè qua nh∆∞ng c·∫ßn l∆∞u √Ω
  - `Error`: L·ªói c·∫ßn x·ª≠ l√Ω, k√®m `WithError(err)`
  - `Debug`: Th√¥ng tin debug (ch·ªâ trong development)

### Log Messages Format
- B·∫Øt ƒë·∫ßu v·ªõi emoji n·∫øu c√≥ (v√≠ d·ª•: üîî [NOTIFICATION])
- S·ª≠ d·ª•ng prefix module trong ngo·∫∑c vu√¥ng (v√≠ d·ª•: [NOTIFICATION], [AUTH])
- Messages ph·∫£i b·∫±ng Ti·∫øng Vi·ªát v√† m√¥ t·∫£ r√µ r√†ng

## üóÑÔ∏è Database Operations

### MongoDB Patterns
- S·ª≠ d·ª•ng `bson.M` ho·∫∑c `bson.D` cho filters
- Lu√¥n x·ª≠ l√Ω `mongo.ErrNoDocuments` v√† convert th√†nh `common.ErrNotFound`
- S·ª≠ d·ª•ng `primitive.ObjectID` cho MongoDB ObjectIDs
- Validate ObjectID tr∆∞·ªõc khi query: `primitive.ObjectIDFromHex()`

### Query Patterns
- Lu√¥n truy·ªÅn `context.Context` v√†o database operations
- S·ª≠ d·ª•ng options (`*options.FindOptions`, `*options.FindOneOptions`) khi c·∫ßn
- Handle nil filters: `if filter == nil { filter = bson.D{} }`
- Lu√¥n tr·∫£ v·ªÅ empty slice `[]T{}` thay v√¨ `nil` cho Find operations

## üéØ Best Practices

### General
1. **Error Handling**: Lu√¥n x·ª≠ l√Ω l·ªói, kh√¥ng b·ªè qua
2. **Context**: S·ª≠ d·ª•ng context cho t·∫•t c·∫£ operations
3. **Validation**: Validate input ·ªü handler layer
4. **Logging**: Log errors v√† important events
5. **Comments**: Comment cho public functions b·∫±ng Ti·∫øng Vi·ªát

### Development Principles (Nguy√™n T·∫Øc Ph√°t Tri·ªÉn)
1. **∆Øu ti√™n CRUD, h·∫°n ch·∫ø t·∫°o endpoint m·ªõi**:
   - Lu√¥n ∆∞u ti√™n s·ª≠ d·ª•ng c√°c CRUD endpoints c√≥ s·∫µn t·ª´ `BaseHandler`
   - Ch·ªâ t·∫°o endpoint m·ªõi khi th·ª±c s·ª± c·∫ßn thi·∫øt v√† kh√¥ng th·ªÉ d√πng CRUD
   - Tr∆∞·ªõc khi t·∫°o endpoint m·ªõi, h·ªèi: "C√≥ th·ªÉ d√πng CRUD v·ªõi filter/query kh√¥ng?"
   - Endpoint m·ªõi ph·∫£i c√≥ l√Ω do r√µ r√†ng v√† ƒë∆∞·ª£c document ƒë·∫ßy ƒë·ªß

2. **Code ph·∫£i ƒë·∫ßy ƒë·ªß ghi ch√∫**:
   - T·∫•t c·∫£ public functions ph·∫£i c√≥ comment m√¥ t·∫£ b·∫±ng Ti·∫øng Vi·ªát
   - Comment ph·∫£i gi·∫£i th√≠ch: m·ª•c ƒë√≠ch, tham s·ªë, gi√° tr·ªã tr·∫£ v·ªÅ, v√† c√°c tr∆∞·ªùng h·ª£p ƒë·∫∑c bi·ªát
   - Complex logic ph·∫£i c√≥ comment gi·∫£i th√≠ch t·∫°i sao l√†m nh∆∞ v·∫≠y
   - Business rules quan tr·ªçng ph·∫£i ƒë∆∞·ª£c comment r√µ r√†ng
   - V√≠ d·ª• comment format:
     ```go
     // HandleCreateCustomer x·ª≠ l√Ω request t·∫°o m·ªõi customer
     // Tham s·ªë:
     //   - c: Fiber context ch·ª©a request body
     // Tr·∫£ v·ªÅ:
     //   - error: L·ªói n·∫øu c√≥ trong qu√° tr√¨nh x·ª≠ l√Ω
     // L∆∞u √Ω: T·ª± ƒë·ªông g√°n OwnerOrganizationID t·ª´ context n·∫øu customer ch∆∞a c√≥
     func (h *CustomerHandler) HandleCreateCustomer(c fiber.Ctx) error {
         // ...
     }
     ```

### Code Quality
- S·ª≠ d·ª•ng generics (`BaseHandler[T, CreateInput, UpdateInput]`) khi c√≥ th·ªÉ
- Tr√°nh code duplication, t√°i s·ª≠ d·ª•ng base handlers/services
- Gi·ªØ functions ng·∫Øn g·ªçn v√† focused
- M·ªôt function ch·ªâ l√†m m·ªôt vi·ªác

### Performance
- S·ª≠ d·ª•ng `defer cursor.Close(ctx)` cho MongoDB cursors
- Tr√°nh N+1 queries, s·ª≠ d·ª•ng aggregation khi c·∫ßn
- Cache k·∫øt qu·∫£ khi ph√π h·ª£p (v√≠ d·ª•: system organization ID)

### Testing
- Vi·∫øt tests cho business logic trong services
- Test error cases v√† edge cases
- S·ª≠ d·ª•ng test fixtures khi c·∫ßn

## üì¶ Dependencies v√† Imports

### Import Organization
```go
import (
    // Standard library
    "context"
    "fmt"
    "time"
    
    // Third-party
    "github.com/gofiber/fiber/v3"
    "go.mongodb.org/mongo-driver/bson"
    "go.mongodb.org/mongo-driver/bson/primitive"
    
    // Internal packages
    models "meta_commerce/core/api/models/mongodb"
    "meta_commerce/core/api/services"
    "meta_commerce/core/common"
    "meta_commerce/core/logger"
)
```

### Package Aliases
- Models: `models "meta_commerce/core/api/models/mongodb"`
- MongoDB options: `mongoopts "go.mongodb.org/mongo-driver/mongo/options"`

## üîÑ Common Patterns

### New Handler Pattern
```go
func NewEntityHandler() (*EntityHandler, error) {
    service, err := services.NewEntityService()
    if err != nil {
        return nil, fmt.Errorf("failed to create entity service: %v", err)
    }
    
    handler := &EntityHandler{
        BaseHandler: *NewBaseHandler[models.Entity, dto.EntityCreateInput, dto.EntityUpdateInput](service.BaseServiceMongoImpl),
        EntityService: service,
    }
    
    return handler, nil
}
```

### New Service Pattern
```go
func NewEntityService() (*EntityService, error) {
    collection, exist := global.RegistryCollections.Get(global.MongoDB_ColNames.Entities)
    if !exist {
        return nil, fmt.Errorf("failed to get entities collection: %v", common.ErrNotFound)
    }
    
    return &EntityService{
        BaseServiceMongoImpl: NewBaseServiceMongo[models.Entity](collection),
    }, nil
}
```

### Response Format
**T·∫§T C·∫¢ API responses PH·∫¢I tu√¢n theo format chu·∫©n sau:**

#### Success Response (Th√†nh c√¥ng)
```go
c.Status(common.StatusOK).JSON(fiber.Map{
    "code":    common.StatusOK,
    "message": "Th√¥ng b√°o th√†nh c√¥ng",
    "data":    result, // D·ªØ li·ªáu tr·∫£ v·ªÅ (c√≥ th·ªÉ l√† object, array, ho·∫∑c null)
    "status":  "success",
})
```

#### Error Response (L·ªói)
```go
c.Status(common.StatusBadRequest).JSON(fiber.Map{
    "code":    common.ErrCodeValidationFormat.Code, // Error code t·ª´ common package
    "message": "Th√¥ng b√°o l·ªói b·∫±ng Ti·∫øng Vi·ªát",
    "status":  "error",
    // Optional: "details" cho th√¥ng tin chi ti·∫øt l·ªói
})
```

#### Quy T·∫Øc Response Format
1. **Lu√¥n d√πng `fiber.Map` thay v√¨ `map[string]interface{}`** ƒë·ªÉ nh·∫•t qu√°n
2. **Lu√¥n set status code** b·∫±ng `c.Status(code)` tr∆∞·ªõc khi g·ªçi `JSON()`
3. **Success response PH·∫¢I c√≥**: `code`, `message`, `data`, `status: "success"`
4. **Error response PH·∫¢I c√≥**: `code`, `message`, `status: "error"`
5. **S·ª≠ d·ª•ng constants t·ª´ `common` package**: `common.StatusOK`, `common.StatusBadRequest`, `common.ErrCodeValidationFormat`, etc.
6. **Message ph·∫£i b·∫±ng Ti·∫øng Vi·ªát** v√† r√µ r√†ng
7. **Kh√¥ng ƒë∆∞·ª£c tr·∫£ v·ªÅ format kh√°c** nh∆∞ `c.JSON(DeliverySendResponse{...})` ho·∫∑c `c.JSON(map[string]string{"error": ...})`

#### V√≠ d·ª• Response Formats

**‚úÖ ƒê√öNG - Success:**
```go
c.Status(common.StatusOK).JSON(fiber.Map{
    "code":    common.StatusOK,
    "message": "Notification ƒë√£ ƒë∆∞·ª£c th√™m v√†o queue",
    "data": map[string]interface{}{
        "eventType": req.EventType,
        "queued":    len(queueItems),
    },
    "status": "success",
})
```

**‚úÖ ƒê√öNG - Error:**
```go
c.Status(common.StatusBadRequest).JSON(fiber.Map{
    "code":    common.ErrCodeValidationFormat.Code,
    "message": "D·ªØ li·ªáu g·ª≠i l√™n kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng JSON",
    "status":  "error",
})
```

**‚ùå SAI - Thi·∫øu format chu·∫©n:**
```go
// SAI: Thi·∫øu code, status
c.JSON(map[string]interface{}{
    "message": "Th√†nh c√¥ng",
    "data": result,
})

// SAI: D√πng struct tr·ª±c ti·∫øp
c.JSON(DeliverySendResponse{
    MessageID: "...",
    Status: "queued",
})

// SAI: Format error kh√¥ng chu·∫©n
c.Status(400).JSON(fiber.Map{
    "error": "Invalid input",
})
```

## ‚ö†Ô∏è L∆∞u √ù Quan Tr·ªçng

### Quy T·∫Øc B·∫Øt Bu·ªôc
1. **∆Øu ti√™n CRUD tr∆∞·ªõc khi t·∫°o endpoint m·ªõi**:
   - Lu√¥n ki·ªÉm tra xem c√≥ th·ªÉ d√πng CRUD endpoints c√≥ s·∫µn kh√¥ng
   - Ch·ªâ t·∫°o endpoint m·ªõi khi th·ª±c s·ª± c·∫ßn thi·∫øt
   - Ph·∫£i c√≥ l√Ω do r√µ r√†ng v√† ƒë∆∞·ª£c approve tr∆∞·ªõc khi t·∫°o endpoint m·ªõi

2. **Code ph·∫£i ƒë·∫ßy ƒë·ªß ghi ch√∫**:
   - T·∫•t c·∫£ public functions PH·∫¢I c√≥ comment ƒë·∫ßy ƒë·ªß b·∫±ng Ti·∫øng Vi·ªát
   - Comment ph·∫£i m√¥ t·∫£: m·ª•c ƒë√≠ch, tham s·ªë, gi√° tr·ªã tr·∫£ v·ªÅ, edge cases
   - Complex logic PH·∫¢I c√≥ comment gi·∫£i th√≠ch
   - Business rules quan tr·ªçng PH·∫¢I ƒë∆∞·ª£c document trong comment

3. **Kh√¥ng hardcode**: S·ª≠ d·ª•ng constants t·ª´ `common` package
4. **Kh√¥ng expose sensitive data**: Kh√¥ng log passwords, tokens, secrets
5. **Validate input**: Lu√¥n validate input ·ªü handler layer
6. **Handle nil**: Lu√¥n ki·ªÉm tra nil tr∆∞·ªõc khi s·ª≠ d·ª•ng
7. **Context propagation**: Lu√¥n truy·ªÅn context qua c√°c layers
8. **Error wrapping**: S·ª≠ d·ª•ng `fmt.Errorf("...: %w", err)` ƒë·ªÉ wrap errors
9. **Organization isolation**: Lu√¥n filter theo `OwnerOrganizationID` khi query

## üö´ Anti-patterns (Tr√°nh)

### Development Anti-patterns
- ‚ùå **KH√îNG t·∫°o endpoint m·ªõi n·∫øu c√≥ th·ªÉ d√πng CRUD**: Lu√¥n ∆∞u ti√™n s·ª≠ d·ª•ng CRUD c√≥ s·∫µn
- ‚ùå **KH√îNG vi·∫øt code kh√¥ng c√≥ comment**: T·∫•t c·∫£ public functions v√† complex logic ph·∫£i c√≥ comment
- ‚ùå **KH√îNG t·∫°o context m·ªõi v·ªõi `context.Background()` trong handlers**: D√πng `c.Context()`
- ‚ùå **KH√îNG b·ªè qua errors**: Lu√¥n x·ª≠ l√Ω errors ƒë·∫ßy ƒë·ªß
- ‚ùå **KH√îNG hardcode error messages**: D√πng constants t·ª´ `common` package
- ‚ùå **KH√îNG expose internal errors ra client**: Ch·ªâ tr·∫£ v·ªÅ error messages an to√†n
- ‚ùå **KH√îNG query m√† kh√¥ng filter theo organization**: Lu√¥n filter theo `OwnerOrganizationID` khi c√≥
- ‚ùå **KH√îNG log sensitive data**: Kh√¥ng log passwords, tokens, API keys
- ‚ùå **KH√îNG s·ª≠ d·ª•ng `panic` trong production code**: Lu√¥n tr·∫£ v·ªÅ error
- ‚ùå **KH√îNG t·∫°o circular dependencies**: Tr√°nh dependencies v√≤ng gi·ªØa packages
- ‚ùå **KH√îNG tr·∫£ v·ªÅ response kh√¥ng ƒë√∫ng format chu·∫©n**: T·∫•t c·∫£ responses ph·∫£i c√≥ `code`, `message`, `data`/`status`, `status: "success"` ho·∫∑c `"error"`